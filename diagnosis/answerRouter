const generateDiagnosis = require("./resultGenerator");

function handleAnswers(userAnswers) {
  // Q1ã€œQ3ã®ã‚¹ã‚³ã‚¢å¤‰æ›
  const scoreMap = { A: -1, B: 1, C: 0 };
  const q1to3 = userAnswers.slice(0, 3); // Q1, Q2, Q3

  const scoreArray = q1to3.map(answer => {
    if (!(answer in scoreMap)) {
      console.warn(`âš ï¸ ç„¡åŠ¹ãªé¸æŠè‚¢ãŒå«ã¾ã‚Œã¦ã„ã¾ã™: ${answer}`);
      return null;
    }
    return Number(scoreMap[answer]);
  });

  if (scoreArray.includes(null)) {
    console.error("âŒ ã‚¹ã‚³ã‚¢å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç„¡åŠ¹ãªå›ç­”ãŒå«ã¾ã‚Œã¦ã„ã¾ã™:", q1to3);
    return {
      type: "ä¸æ˜ãªä½“è³ªã‚¿ã‚¤ãƒ—",
      traits: "",
      flowIssue: "",
      organBurden: "",
      advice: "è¨ºæ–­ã«å¿…è¦ãªå›ç­”ãŒä¸è¶³ã¾ãŸã¯ç„¡åŠ¹ã§ã—ãŸã€‚",
      link: ""
    };
  }

  console.log("ğŸ“Š scoreArray:", scoreArray);
  console.log("ğŸ”‘ scoreKey:", `${scoreArray[0]},${scoreArray[1]},${scoreArray[2]}`);

  // Q4 â†’ flowç—…ç†
  let flow = "";
  switch (userAnswers[3]) {
    case "A": flow = "æ°—æ»"; break;
    case "B": flow = "ç—°æ¹¿"; break;
    case "C": flow = "ç˜€è¡€"; break;
    case "D": flow = "å·¡ã‚Šã¯è‰¯å¥½"; break;
    default: flow = "ä¸æ˜"; break;
  }

  // Q5 â†’ è‡“è…‘å½±éŸ¿ï¼ˆå‹•ä½œãƒ†ã‚¹ãƒˆçµæœï¼‰
  let organ = "";
  let motion = "";
  switch (userAnswers[4]) {
    case "A": organ = "è‚ºãƒ»å¤§è…¸"; motion = "é¦–ã®å›æ—‹"; break;
    case "B": organ = "å¿ƒãƒ»å°è…¸"; motion = "è…•ã®æŒ™ä¸Š"; break;
    case "C": organ = "è…ãƒ»è†€èƒ±"; motion = "å‰å±ˆ"; break;
    case "D": organ = "è‚ãƒ»èƒ†";   motion = "ä½“å¹¹ã®ã­ã˜ã‚Œãƒ»å´å±ˆ"; break;
    case "E": organ = "è„¾ãƒ»èƒƒ";   motion = "å¾Œå±ˆ"; break;
    default: organ = "ä¸æ˜";      motion = "ç‰¹å®šã®å‹•ä½œ"; break;
  }

  // Q0 â†’ ä¸»è¨´ï¼ˆsessionã‹ã‚‰æŒã£ã¦ãã‚‹å¿…è¦ã‚ã‚Šï¼šä¸€æ™‚çš„ã«ä¸æ˜ã§å‡¦ç†ï¼‰
  const symptom = "ä¸æ˜ãªä¸èª¿"; // â† diagnosis/index.jså´ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ãªã‚‰ã“ã“ã‚’ä¿®æ­£

  // âœ… è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯å‘¼ã³å‡ºã—ï¼ˆsymptomã¨motionã‚’è¿½åŠ ï¼‰
  const result = generateDiagnosis(
    scoreArray[0],
    scoreArray[1],
    scoreArray[2],
    flow,
    organ,
    symptom,
    motion
  );

  return result;
}

module.exports = { handleAnswers };
